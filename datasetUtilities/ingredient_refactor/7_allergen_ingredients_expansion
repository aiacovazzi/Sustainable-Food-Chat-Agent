from pymongo import MongoClient
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
import os

def update_allergies():
    client = MongoClient('localhost', 27017)
    db_1 = client['emealio_food_db']
    collection1 = db_1['ingredients']



    db_2 = client['emealio_allergy']
    collection2 = db_2['ingredients']

    #loop over all ingredients in collection1
    for ingredient in collection1.find():
        #take the item in db_2 that has the same id
        item = collection2.find_one({"_id": ingredient["_id"]})
        #save in db_1 item the field allergen and allergen type
        if item["allergen"] == "Yes":
            collection1.update_one({"_id": ingredient["_id"]}, {"$set": {"allergen": item["allergen"], "allergen_type": item["allergen type"]}})
        else:
            collection1.update_one({"_id": ingredient["_id"]}, {"$set": {"allergen": False, "allergen_type": None}})

def update_recipes():
    client = MongoClient('localhost', 27017)
    db_1 = client['emealio_food_db']
    collection1 = db_1['recipes']

    db_2 = client['emealio_allergy']
    collection2 = db_2['recipes']

    i = 0
    #loop over all recipes in collection1
    for recipe in collection1.find():
        #take the item in db_2 that has the same id
        item = collection2.find_one({"_id": recipe["_id"]})
        #update the tags of the recipe in collection1 with the tags of the recipe in collection2
        if "tags" in item:
            collection1.update_one({"_id": recipe["_id"]}, {"$set": {"tags": item["tags"]}})
        #if the item in collection2 has the field allergens, update the allergens of the recipe in collection1 with the allergens of the recipe in collection2
        if "allergens" in item:
            collection1.update_one({"_id": recipe["_id"]}, {"$set": {"allergens": item["allergens"]}})
        else:
            collection1.update_one({"_id": recipe["_id"]}, {"$unset": {"allergens": ""}})

        if i % 1000 == 0:
            print(i)
        
        i += 1

update_recipes()